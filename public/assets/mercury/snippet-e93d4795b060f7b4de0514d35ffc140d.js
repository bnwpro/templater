(function(){var t={}.hasOwnProperty;this.Mercury.Snippet=function(){function e(t,e,i){this.name=t,this.identity=e,null==i&&(i={}),this.version=0,this.data="",this.wrapperTag="div",this.wrapperClass="",this.history=new Mercury.HistoryBuffer,this.setOptions(i)}return e.all=[],e.displayOptionsFor=function(t,e,i){var n;return null==e&&(e={}),null==i&&(i=!0),i?Mercury.modal(this.optionsUrl(t),jQuery.extend({title:"Snippet Options",handler:"insertSnippet",snippetName:t,loadType:Mercury.config.snippets.method},e)):(n=Mercury.Snippet.create(t),Mercury.trigger("action",{action:"insertSnippet",value:n})),Mercury.snippet=null},e.optionsUrl=function(t){var e;return e=Mercury.config.snippets.optionsUrl,"function"==typeof e&&(e=e()),e.replace(":name",t)},e.previewUrl=function(t){var e;return e=Mercury.config.snippets.previewUrl,"function"==typeof e&&(e=e()),e.replace(":name",t)},e.create=function(t,e){var i;return i=new Mercury.Snippet(t,this.uniqueId(),e),this.all.push(i),i},e.uniqueId=function(){var t,e,i,n,r;for(r=[0,"snippet_0"],t=r[0],i=r[1],e=function(){var t,e,i,r;for(i=this.all,r=[],t=0,e=i.length;e>t;t++)n=i[t],r.push(n.identity);return r}.call(this);-1!==e.indexOf(i);)t+=1,i="snippet_"+t;return i},e.find=function(t){var e,i,n,r;for(r=this.all,i=0,n=r.length;n>i;i++)if(e=r[i],e.identity===t)return e;return null},e.load=function(e){var i,n,r,s;s=[];for(n in e)t.call(e,n)&&(i=e[n],r=new Mercury.Snippet(i.name,n,i),s.push(this.all.push(r)));return s},e.clearAll=function(){return delete this.all,this.all=[]},e.prototype.getHTML=function(t,e){var i,n;return null==e&&(e=null),n=""+this.name+"-snippet",this.wrapperClass&&(n+=" "+this.wrapperClass),i=jQuery("<"+this.wrapperTag+">",{"class":n,contenteditable:"false","data-snippet":this.identity,"data-version":this.version},t),i.html("["+this.identity+"]"),this.loadPreview(i,e),i},e.prototype.getText=function(){return"[--"+this.identity+"--]"},e.prototype.loadPreview=function(t,i){var n=this;return null==i&&(i=null),jQuery.ajax(e.previewUrl(this.name),{headers:Mercury.ajaxHeaders(),type:Mercury.config.snippets.method,data:this.options,success:function(e){return n.data=e,t.html(e),i?i():void 0},error:function(){return Mercury.notify('Error loading the preview for the "%s" snippet.',n.name)}})},e.prototype.displayOptions=function(){return Mercury.snippet=this,Mercury.modal(e.optionsUrl(this.name),{title:"Snippet Options",handler:"insertSnippet",loadType:Mercury.config.snippets.method,loadData:this.options})},e.prototype.setOptions=function(t){return this.options=t,delete this.options.authenticity_token,delete this.options.utf8,this.options.wrapperTag&&(this.wrapperTag=this.options.wrapperTag),this.options.wrapperClass&&(this.wrapperClass=this.options.wrapperClass),this.version+=1,this.history.push(this.options)},e.prototype.setVersion=function(t){return null==t&&(t=null),t=parseInt(t),t&&this.history.stack[t-1]?(this.version=t,this.options=this.history.stack[t-1],!0):!1},e.prototype.serialize=function(){return $.extend({name:this.name},this.options)},e}()}).call(this);